<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Prenotazione - Eleven Cocktail Bar</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color-scheme: dark;
      }
      body {
        margin: 0;
        background: #0b0f14;
        color: #eef2f7;
      }
      .wrap {
        max-width: 720px;
        margin: 0 auto;
        padding: 24px;
      }
      .card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      h1 {
        margin: 0 0 10px;
        font-size: 22px;
      }
      p {
        margin: 0 0 18px;
        opacity: 0.9;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      label {
        display: block;
        font-size: 13px;
        opacity: 0.9;
        margin: 0 0 6px;
      }
      input,
      textarea,
      select {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(0, 0, 0, 0.25);
        color: #eef2f7;
        outline: none;
      }
      input:focus,
      textarea:focus,
      select:focus {
        border-color: rgba(99, 179, 237, 0.9);
      }
      textarea {
        min-height: 84px;
        resize: vertical;
      }
      .full {
        grid-column: 1 / -1;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(99, 179, 237, 0.22);
        color: #eef2f7;
        cursor: pointer;
        font-weight: 700;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        margin-top: 14px;
      }
      .status {
        font-size: 13px;
        opacity: 0.92;
      }
      .ok {
        color: #7ee787;
      }
      .err {
        color: #ff7b72;
      }
      .hint {
        margin-top: 10px;
        font-size: 12px;
        opacity: 0.75;
      }
      @media (max-width: 640px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      /* POPUP CONFERMA */
      .modal {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        background: rgba(0, 0, 0, 0.65);
        padding: 20px;
        z-index: 9999;
      }
      .modal.show {
        display: grid;
      }
      .modal-card {
        width: min(720px, 100%);
        background: rgba(18, 24, 33, 0.98);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.55);
      }
      .modal-card h2 {
        margin: 0 0 10px;
        font-size: 18px;
      }
      .modal-text {
        white-space: pre-wrap;
        margin: 0;
        padding: 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.10);
        font-size: 14px;
        line-height: 1.45;
      }
      .modal-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 12px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <h1>Prenota un tavolo</h1>
        <p>Compila il modulo e premi <b>Conferma prenotazione</b>. Riceverai una risposta appena possibile.</p>

        <form id="bookingForm">
          <div class="grid">
            <div class="full">
              <label for="nome">Nome e cognome *</label>
              <input id="nome" name="nome" placeholder="Es. Mario Rossi" required />
            </div>

            <div>
              <label for="data">Data *</label>
              <input id="data" name="data" type="date" required />
            </div>
            <div>
              <label for="ora">Orario *</label>
              <input id="ora" name="ora" type="time" required />
            </div>

            <div>
              <label for="persone">Numero persone *</label>
              <select id="persone" name="persone" required>
                <option value="">Seleziona</option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
                <option>10</option>
              </select>
            </div>

            <div>
              <label for="telefono">Telefono *</label>
              <input id="telefono" name="telefono" placeholder="Es. +39 333 1234567" required />
            </div>

            <div class="full">
              <label for="email">Email *</label>
              <input id="email" name="email" type="email" placeholder="Es. nome@email.it" required />
            </div>

            <div class="full">
              <label for="note">Note (facoltative)</label>
              <textarea id="note" name="note" placeholder="Es. compleanno, allergie, richieste particolari..."></textarea>
            </div>
          </div>

          <div class="row">
            <button id="submitBtn" class="btn" type="submit">Conferma prenotazione</button>
            <div id="status" class="status"></div>
          </div>

          <div class="hint">
            Nota tecnica: questo modulo invia una notifica su ntfy (funziona anche con PC spento).
          </div>
        </form>
      </div>
    </div>

    <!-- POPUP CONFERMA PRENOTAZIONE -->
    <div id="confirmModal" class="modal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <h2 id="modalTitle">Prenotazione confermata ✅</h2>
        <pre id="modalText" class="modal-text"></pre>

        <div class="modal-actions">
          <button type="button" id="closeModalBtn" class="btn">Chiudi</button>
        </div>
      </div>
    </div>

    <script>
      const NTFY_TOPIC = "prenotazioni-eleven-cocktail-bar";
      const NTFY_TITLE = "Nuova prenotazione Eleven Cocktail Bar";
      const NTFY_PRIORITY = "5";
      const NTFY_TAGS = "prenotazione";

      const form = document.getElementById("bookingForm");
      const statusEl = document.getElementById("status");
      const btn = document.getElementById("submitBtn");

      // Popup elements
      const modal = document.getElementById("confirmModal");
      const modalTextEl = document.getElementById("modalText");
      const closeModalBtn = document.getElementById("closeModalBtn");

      function setStatus(msg, kind) {
        statusEl.textContent = msg;
        statusEl.className = "status " + (kind || "");
      }

      function formatDateIT(yyyy_mm_dd) {
        if (!yyyy_mm_dd || typeof yyyy_mm_dd !== "string") return yyyy_mm_dd;
        const parts = yyyy_mm_dd.split("-");
        if (parts.length !== 3) return yyyy_mm_dd;
        const [y, m, d] = parts;
        return `${d}/${m}/${y.slice(-2)}`;
      }

      function openModal(text) {
        modalTextEl.textContent = text;
        modal.classList.add("show");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeModal() {
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden", "true");
      }

      closeModalBtn.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("show")) closeModal();
      });

      function buildMessage(values) {
        const lines = [];
        lines.push(`Nome: ${values.nome}`);
        lines.push(`Data: ${values.data}`);
        lines.push(`Ora: ${values.ora}`);
        lines.push(`Persone: ${values.persone}`);
        lines.push(`Telefono: ${values.telefono}`);
        lines.push(`Email: ${values.email}`);
        if (values.note) lines.push(`Note: ${values.note}`);
        return lines.join("\n");
      }

      function buildClientConfirmation(values) {
        const nome = values.nome;
        const persone = values.persone;
        const dataIT = formatDateIT(values.data);
        const ora = values.ora;

        return `Ciao ${nome}, ti confermiamo la tua prenotazione per ${persone}, ti aspettiamo il ${dataIT} alle ${ora} e ti ricordiamo che il tavolo viene riservato per 30 minuti oltre l'orario di prenotazione.

Dopo 30 minuti di ritardo il tavolo viene annullato per dare la possibilità ad altri ospiti di accomodarsi.

Grazie per la prenotazione.

Buona giornata,
Manuel`;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const data = new FormData(form);
        const values = {
          nome: (data.get("nome") || "").toString().trim(),
          data: (data.get("data") || "").toString(),
          ora: (data.get("ora") || "").toString(),
          persone: (data.get("persone") || "").toString(),
          telefono: (data.get("telefono") || "").toString().trim(),
          email: (data.get("email") || "").toString().trim(),
          note: (data.get("note") || "").toString().trim(),
        };

        if (!values.nome || !values.data || !values.ora || !values.persone || !values.telefono || !values.email) {
          setStatus("Compila tutti i campi obbligatori.", "err");
          return;
        }

        const message = buildMessage(values);
        const url = `https://ntfy.sh/${encodeURIComponent(NTFY_TOPIC)}`;

        btn.disabled = true;
        setStatus("Invio in corso...", "");

        try {
          const res = await fetch(url, {
            method: "POST",
            headers: {
              "Title": NTFY_TITLE,
              "Priority": NTFY_PRIORITY,
              "Tags": NTFY_TAGS,
              "Content-Type": "text/plain; charset=utf-8",
            },
            body: message,
          });

          if (!res.ok) {
            const text = await res.text().catch(() => "");
            throw new Error(`Errore ntfy: ${res.status} ${text}`);
          }

          setStatus("Prenotazione inviata! Ti risponderemo al più presto.", "ok");
          openModal(buildClientConfirmation(values));
          form.reset();
        } catch (err) {
          console.error(err);
          setStatus("Errore durante l'invio. Riprova tra poco.", "err");
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
